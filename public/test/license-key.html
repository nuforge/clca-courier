<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>License Key Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .log {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>PDFTron License Key Test</h1>

      <div class="log info" id="env-log">Checking environment variables...</div>

      <button onclick="testLicenseKey()">Test License Key Integration</button>
      <button onclick="testThumbnailGeneration()">Test Thumbnail Generation</button>

      <div id="test-log" class="log"></div>
      <div id="result"></div>
    </div>

    <script>
      function log(message, type = 'info') {
          const logElement = document.getElementById('test-log');
          const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
          const timestamp = new Date().toLocaleTimeString();
          const logEntry = '<div class="log ' + className + '">[' + timestamp + '] ' + message + '</div>';
          logElement.innerHTML += logEntry;
      }

      // Check environment variable on page load
      window.addEventListener('load', () => {
          const envLogElement = document.getElementById('env-log');
          const licenseKey = import.meta.env.VITE_PDFTRON_LICENSE_KEY;

          if (licenseKey) {
              const maskedKey = licenseKey.substring(0, 10) + '...' + licenseKey.substring(licenseKey.length - 10);
              envLogElement.innerHTML = `âœ… License key found: ${maskedKey}`;
              envLogElement.className = 'log success';
          } else {
              envLogElement.innerHTML = 'âŒ No license key found in environment';
              envLogElement.className = 'log error';
          }
      });

      function testLicenseKey() {
          log('Testing license key integration...', 'info');

          const licenseKey = import.meta.env.VITE_PDFTRON_LICENSE_KEY;

          if (!licenseKey) {
              log('âŒ FAIL: No license key found in environment variables', 'error');
              return;
          }

          log(`âœ… License key loaded: ${licenseKey.substring(0, 20)}...`, 'success');

          // Test if it looks like a valid PDFTron license
          if (licenseKey.startsWith('demo:')) {
              log('ðŸ“ License type: Demo license detected', 'info');
          } else if (licenseKey.length > 20) {
              log('ðŸ“ License type: Production license detected', 'info');
          } else {
              log('âš ï¸ License format: Unusual license format', 'error');
          }

          log('âœ… License key integration test complete', 'success');
      }

      async function testThumbnailGeneration() {
          log('Starting thumbnail generation test with license key...', 'info');

          const licenseKey = import.meta.env.VITE_PDFTRON_LICENSE_KEY;
          if (!licenseKey) {
              log('âŒ Cannot test without license key', 'error');
              return;
          }

          // Test URL
          const testUrl = '/issues/7.2025.pdf';
          log(`Testing with URL: ${testUrl}`, 'info');

          try {
              // Create container
              const container = document.createElement('div');
              container.style.position = 'fixed';
              container.style.left = '-1000px';
              container.style.top = '0';
              container.style.width = '400px';
              container.style.height = '600px';
              container.style.visibility = 'hidden';
              document.body.appendChild(container);

              log('Container created, initializing WebViewer...', 'info');

              // Initialize WebViewer with license
              const instance = await WebViewer({
                  path: '/webviewer',
                  initialDoc: testUrl,
                  licenseKey: licenseKey,
                  disabledElements: ['header', 'toolsHeader']
              }, container);

              log('âœ… WebViewer initialized successfully with license key', 'success');

              const { documentViewer } = instance.Core;

              // Listen for document loaded
              const documentLoadPromise = new Promise((resolve, reject) => {
                  const timeout = setTimeout(() => {
                      reject(new Error('Document load timeout'));
                  }, 15000);

                  documentViewer.addEventListener('documentLoaded', () => {
                      clearTimeout(timeout);
                      resolve();
                  });

                  documentViewer.addEventListener('documentLoadError', (err) => {
                      clearTimeout(timeout);
                      reject(err);
                  });
              });

              await documentLoadPromise;
              log('âœ… Document loaded successfully', 'success');

              // Wait for rendering
              await new Promise(resolve => setTimeout(resolve, 3000));

              // Check for canvas elements
              const canvases = container.querySelectorAll('canvas');
              log(`Found ${canvases.length} canvas elements`, 'info');

              let hasValidCanvas = false;
              canvases.forEach((canvas, index) => {
                  log(`Canvas ${index + 1}: ${canvas.width}x${canvas.height}`, 'info');
                  if (canvas.width > 100 && canvas.height > 100) {
                      hasValidCanvas = true;
                  }
              });

              if (hasValidCanvas) {
                  log('âœ… SUCCESS: Valid canvas elements found - thumbnail generation should work!', 'success');
              } else {
                  log('âš ï¸ WARNING: No valid canvas elements found', 'error');
              }

              // Cleanup
              await instance.UI.dispose();
              document.body.removeChild(container);

              log('âœ… Test completed successfully', 'success');

          } catch (error) {
              log(`âŒ Test failed: ${error.message}`, 'error');
          }
      }

      // Load WebViewer script
      function loadWebViewer() {
          return new Promise((resolve, reject) => {
              if (window.WebViewer) {
                  resolve();
                  return;
              }

              const script = document.createElement('script');
              script.src = '/webviewer/webviewer.min.js';
              script.onload = resolve;
              script.onerror = reject;
              document.head.appendChild(script);
          });
      }

      // Initialize
      window.addEventListener('load', async () => {
          try {
              await loadWebViewer();
              log('WebViewer library loaded successfully', 'success');
          } catch (error) {
              log(`Failed to load WebViewer: ${error.message}`, 'error');
          }
      });
    </script>
  </body>
</html>
