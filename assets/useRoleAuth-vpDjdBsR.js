import{r as $,f as n,w as q,a2 as C,l as t}from"./index-C_JkpTYA.js";import{u as E}from"./useFirebase-Dw-FPQcY.js";import{firestoreService as W}from"./firebase-firestore.service-DPj3Rf11.js";const x=()=>{const i=C(),{auth:a}=E(),l=$(null),c=$(!1),d=n(()=>a.isAuthenticated.value),f=n(()=>a.isLoading.value),u=n(()=>l.value?.role||"reader"),U=n(()=>u.value==="admin"),w=n(()=>u.value==="editor"||u.value==="admin"),A=n(()=>["contributor","editor","admin"].includes(u.value)),v=n(()=>f.value?!1:d.value?!c.value:!0),h=e=>{const o={reader:0,contributor:1,editor:2,admin:3},r=o[u.value]||0,s=o[e]||0;return r>=s},b=async()=>{if(!a.currentUser.value){l.value=null;return}c.value=!0;try{const e=await W.getUserProfile(a.currentUser.value.uid);l.value=e,t.debug("User profile loaded:",{uid:a.currentUser.value.uid,role:e?.role,email:a.currentUser.value.email}),e?t.info(`User ${e.email} has role: ${e.role}`):t.warn(`No profile found for user ${a.currentUser.value.email}, defaulting to reader role`)}catch(e){t.error("Error loading user profile:",e),l.value=null}finally{c.value=!1}},p=(e,o="/")=>{if(t.debug(`requireRole called - required: ${e}, authLoading: ${f.value}, authenticated: ${d.value}, profileLoading: ${c.value}, currentRole: ${u.value}, authReady: ${v.value}`),f.value)return t.debug("Firebase Auth still initializing, allowing temporary access"),!0;if(!d.value)return t.warn("Unauthorized access attempt - not authenticated"),i.push(o),!1;if(c.value)return t.debug("User profile still loading, allowing temporary access"),!0;const r=h(e);return t.debug(`Role check result: ${r} (required: ${e}, user: ${u.value})`),r?(t.success(`Access granted - user ${u.value} meets requirement ${e}`),!0):(t.warn(`Insufficient permissions - required: ${e}, user: ${u.value}`),i.push(o),!1)},y=(e="/")=>p("admin",e),P=(e="/")=>p("editor",e),k=(e="/")=>p("contributor",e),L=()=>{const e=i.currentRoute.value,r=[{path:"/admin/content",requiredRole:"editor"},{path:"/admin",requiredRole:"admin"}].find(s=>e.path.startsWith(s.path));return r?{isProtected:!0,requiredRole:r.requiredRole}:{isProtected:!1}};q(()=>a.currentUser.value,(e,o)=>{if(e)b();else if(l.value=null,o&&!e){t.info("User logged out, checking if on protected route");const r=i.currentRoute.value;["/admin","/admin/content"].some(g=>r.path.startsWith(g))&&(t.warn("User logged out while on protected route, redirecting to home"),i.push("/"))}},{immediate:!0});const R=$([]);return q(()=>v.value,e=>{if(e&&R.value.length>0){const o=[...R.value];R.value=[];for(const{role:r,redirectTo:s}of o)if(!d.value||!h(r)){t.warn(`Deferred role check failed - required: ${r}, user: ${u.value}`),i.push(s);break}}}),q([d,u],([e,o])=>{if(!v.value)return;const r=i.currentRoute.value,m=[{path:"/admin/content",requiredRole:"editor"},{path:"/admin",requiredRole:"admin"}].find(g=>r.path.startsWith(g.path));m&&(!e||!h(m.requiredRole))&&(t.warn(`Access revoked for route ${r.path} - required: ${m.requiredRole}, user: ${o}, authenticated: ${e}`),i.push("/"))},{immediate:!1}),{userProfile:l,isLoading:c,isAuthReady:v,isAuthenticated:d,isAuthLoading:f,userRole:u,isAdmin:U,isEditor:w,isContributor:A,hasRole:h,loadUserProfile:b,requireRole:p,requireAdmin:y,requireEditor:P,requireContributor:k,isCurrentRouteProtected:L}};export{x as u};
