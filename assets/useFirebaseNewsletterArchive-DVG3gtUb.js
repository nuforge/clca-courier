import{c as X,aD as Z,aE as ee,h as te,r as u,q as $,l,f as s,w as x,_ as ae}from"./index-C_JkpTYA.js";import{f as g}from"./firebase-newsletter.service-D7ooak-t.js";import{firestoreService as L}from"./firebase-firestore.service-DPj3Rf11.js";const re='<g><path fill="none" stroke="currentColor" stroke-width="5" stroke-miterlimit="10" d="M58.4,51.7c-0.9-0.9-1.4-2-1.4-2.3s0.5-0.4,1.4-1.4 C70.8,43.8,79.8,30.5,80,15.5H70H30H20c0.2,15,9.2,28.1,21.6,32.3c0.9,0.9,1.4,1.2,1.4,1.5s-0.5,1.6-1.4,2.5 C29.2,56.1,20.2,69.5,20,85.5h10h40h10C79.8,69.5,70.8,55.9,58.4,51.7z"></path><clipPath id="uil-hourglass-clip1"><rect x="15" y="20" width="70" height="25"><animate attributeName="height" from="25" to="0" dur="1s" repeatCount="indefinite" values="25;0;0" keyTimes="0;0.5;1"></animate><animate attributeName="y" from="20" to="45" dur="1s" repeatCount="indefinite" values="20;45;45" keyTimes="0;0.5;1"></animate></rect></clipPath><clipPath id="uil-hourglass-clip2"><rect x="15" y="55" width="70" height="25"><animate attributeName="height" from="0" to="25" dur="1s" repeatCount="indefinite" values="0;25;25" keyTimes="0;0.5;1"></animate><animate attributeName="y" from="80" to="55" dur="1s" repeatCount="indefinite" values="80;55;55" keyTimes="0;0.5;1"></animate></rect></clipPath><path d="M29,23c3.1,11.4,11.3,19.5,21,19.5S67.9,34.4,71,23H29z" clip-path="url(#uil-hourglass-clip1)" fill="currentColor"></path><path d="M71.6,78c-3-11.6-11.5-20-21.5-20s-18.5,8.4-21.5,20H71.6z" clip-path="url(#uil-hourglass-clip2)" fill="currentColor"></path><animateTransform attributeName="transform" type="rotate" from="0 50 50" to="180 50 50" repeatCount="indefinite" dur="1s" values="0 50 50;0 50 50;180 50 50" keyTimes="0;0.7;1"></animateTransform></g>',ne=X({name:"QSpinnerHourglass",props:Z,setup(a){const{cSize:v,classes:w}=ee(a);return()=>te("svg",{class:w.value,width:v.value,height:v.value,viewBox:"0 0 100 100",preserveAspectRatio:"xMidYMid",xmlns:"http://www.w3.org/2000/svg",innerHTML:re})}});function oe(){const a=u([]),v=u([]),w=u(null),y=u(!1),N=u(!1),h=u(null),C=u(!1),d=u({}),b=u(""),p=u(null),H=u("public"),P=(e=!1)=>{p.value&&(p.value(),p.value=null);const t=e?"admin":"public";H.value=t,l.info(`Setting up ${t} newsletter subscription for archive...`),e?p.value=L.subscribeToNewslettersForAdmin(r=>{l.info(`Archive received ${r.length} newsletters via admin subscription`),a.value=r,m()}):p.value=L.subscribeToNewsletters(r=>{l.info(`Archive received ${r.length} published newsletters via public subscription`),a.value=r,m()})};$(()=>{p.value&&(p.value(),l.info("Archive newsletter subscription cleaned up"))});const T=s(()=>{if(a.value.length===0)return null;try{const e=[...new Set(a.value.map(i=>i.year).filter(i=>i!=null))].sort((i,z)=>z-i),t=[...new Set(a.value.flatMap(i=>i.tags||[]))].sort(),r=e,f=t,n=a.value.filter(i=>!!i.description).length,c=a.value.filter(i=>!!i.thumbnailUrl).length,o=a.value.filter(i=>!!i.searchableText).length,A=a.value.reduce((i,z)=>i+(z.pageCount||0),0),E=a.value.length>0?Math.round(A/a.value.length):0;return{totalNewsletters:a.value.length,publishedThisYear:a.value.filter(i=>i.year===new Date().getFullYear()).length,availableYears:r,availableTags:f,sourceCounts:{firebase:a.value.length,local:0,drive:0,hybrid:0},accessibility:{withDescriptions:n,withThumbnails:c,withSearchableText:o,averagePageCount:E}}}catch(e){return l.error("Error generating stats:",e),null}}),B=s(()=>v.value.length>0),I=s(()=>{const e=d.value;return!!(e.year||e.month||e.tags?.length||e.featured!==void 0||e.contentType||e.availability||e.pageCount||e.actions||b.value.trim())}),D=s(()=>{const e=[...v.value],t=d.value.sortBy||"date-desc",[r,f]=t.split("-");return e.sort((n,c)=>{let o=0;switch(r){case"date":{const A=new Date(n.publicationDate),E=new Date(c.publicationDate);o=A.getTime()-E.getTime();break}case"title":o=n.title.localeCompare(c.title);break;case"pages":o=(n.pageCount||0)-(c.pageCount||0);break}return f==="desc"?-o:o})}),R=s(()=>{const e=new Map;return D.value.forEach(t=>{const r=t.year;r!=null&&!e.has(r)&&e.set(r,[]),r!=null&&e.get(r).push(t)}),Array.from(e.entries()).map(([t,r])=>({year:t,newsletters:r})).sort((t,r)=>r.year-t.year)}),M=s(()=>T.value?T.value.availableYears:[]),O=s(()=>T.value?T.value.availableTags:[]),Q=s(()=>M.value.filter(e=>e!=null).map(e=>({label:e.toString(),value:e}))),k=async()=>{if(!C.value)try{y.value=!0,h.value=null,l.info("Initializing Firebase Newsletter Archive..."),await g.initialize(),x(()=>g.newsletters.value,e=>{a.value=[...e],m()},{immediate:!0}),C.value=!0,l.success("Firebase Newsletter Archive initialized successfully")}catch(e){throw h.value=e instanceof Error?e.message:"Failed to initialize archive",l.error("Error initializing Firebase Newsletter Archive:",e),e}finally{y.value=!1}},J=async(e=!1)=>{try{y.value=!0,h.value=null,l.info(`Initializing reactive subscription for ${e?"admin":"public"} mode...`),P(e),await new Promise(t=>setTimeout(t,200)),l.success(`Initialized reactive subscription for newsletters${e?" (including unpublished)":""}`)}catch(t){throw h.value=t instanceof Error?t.message:"Failed to initialize newsletter subscription",l.error("Error initializing newsletter subscription:",t),t}finally{y.value=!1}},F=async e=>{try{if(N.value=!0,h.value=null,b.value=e,!e.trim()){w.value=null,await m();return}l.info(`Searching newsletters for: "${e}"`);const t=await g.searchNewsletters(e,d.value);w.value=t,v.value=t.newsletters,l.success(`Search found ${t.newsletters.length} results`)}catch(t){throw h.value=t instanceof Error?t.message:"Search failed",l.error("Error searching newsletters:",t),t}finally{N.value=!1}},m=async()=>{try{if(b.value.trim()){await F(b.value);return}const e=await g.searchNewsletters("",d.value);v.value=e.newsletters,l.debug(`Applied filters, ${e.newsletters.length} newsletters match`)}catch(e){h.value=e instanceof Error?e.message:"Failed to apply filters",l.error("Error applying filters:",e)}},W=async e=>{d.value={...d.value,...e},await m()},_=()=>{d.value={},b.value="",w.value=null,v.value=a.value,l.info("Filters cleared")},j=async e=>{try{return await g.getNewsletterById(e)}catch(t){throw h.value=t instanceof Error?t.message:"Failed to get newsletter",l.error("Error getting newsletter by ID:",t),t}},q=(e=5)=>g.getFeaturedNewsletters(e),Y=s(()=>{const e=new Date().getFullYear();return{currentYear:a.value.filter(t=>t.year===e),lastYear:a.value.filter(t=>t.year===e-1),featured:a.value.filter(t=>t.featured),withDescriptions:a.value.filter(t=>!!t.description),recentlyAdded:a.value.sort((t,r)=>new Date(r.createdAt).getTime()-new Date(t.createdAt).getTime()).slice(0,10)}}),G=()=>Y.value,K=e=>{if(!e||e.length<2)return[];const t=new Set,r=e.toLowerCase();return a.value.forEach(f=>{if(f.title.toLowerCase().includes(r)&&f.title.split(" ").forEach(c=>{c.toLowerCase().startsWith(r)&&t.add(c)}),f.tags.forEach(n=>{n.toLowerCase().includes(r)&&t.add(n)}),f.publicationDate){const n=["January","February","March","April","May","June","July","August","September","October","November","December"],c=new Date(f.publicationDate).getMonth(),o=n[c];o&&o.toLowerCase().includes(r)&&t.add(o)}}),Array.from(t).slice(0,8)},U=()=>{const e=[];return a.value.forEach(t=>{t.description||e.push(`Newsletter "${t.title}" missing description for screen readers`),t.thumbnailUrl||e.push(`Newsletter "${t.title}" missing thumbnail for visual identification`),t.searchableText||e.push(`Newsletter "${t.title}" missing searchable text for content discovery`)}),{totalIssues:e.length,issues:e.slice(0,20),complianceRate:a.value.length>0?Math.round((a.value.length-e.length/3)/a.value.length*100):100}};let S;const V=(e,t=300)=>{clearTimeout(S),S=setTimeout(()=>{F(e)},t)};return x(()=>g.newsletters.value,e=>{a.value=e,m()},{deep:!0}),ae(()=>{k()}),$(()=>{clearTimeout(S),g.destroy()}),{newsletters:s(()=>a.value),filteredNewsletters:s(()=>v.value),sortedNewsletters:D,newslettersByYear:R,searchResults:s(()=>w.value),isLoading:s(()=>y.value),isSearching:s(()=>N.value),error:s(()=>h.value),stats:s(()=>T.value),initialized:s(()=>C.value),currentFilters:s(()=>d.value),searchQuery:s(()=>b.value),hasResults:B,hasActiveFilters:I,availableYears:M,availableTags:O,yearFilterOptions:Q,quickFilterOptions:Y,initialize:k,loadNewsletters:J,searchNewsletters:F,debouncedSearch:V,applyFilters:m,updateFilters:W,clearFilters:_,getNewsletterById:j,getFeaturedNewsletters:q,getQuickFilterOptions:G,getSearchSuggestions:K,validateAccessibility:U}}export{ne as Q,oe as u};
