import{f as w}from"./firebase-auth.service-DUJ5rzAl.js";import{firestoreService as c}from"./firebase-firestore.service-DPj3Rf11.js";import{firebaseStorageService as y}from"./firebase-storage.service-is7ocZr7.js";import{r as i,_ as P,q as m,f as F,w as S,l as s}from"./index-C_JkpTYA.js";function b(){const r=i({user:null,isAuthenticated:!1,isLoading:!0,error:null});let l=null;P(()=>{l=w.onAuthStateChange(v=>{r.value=v})}),m(()=>{l?.()});const a=F(()=>r.value.isAuthenticated),f=F(()=>r.value.isLoading),d=F(()=>r.value.user),h=F(()=>r.value.error),u=async v=>{try{await w.signInWithPopup(v),s.success(`Signed in with ${v}`)}catch(p){throw s.error("Sign in failed:",p),p}},n=async v=>{try{await w.signInWithRedirect(v),s.info(`Redirecting for ${v} sign in...`)}catch(p){throw s.error("Redirect sign in failed:",p),p}},e=async()=>{try{await w.signOut(),s.success("Signed out successfully")}catch(v){throw s.error("Sign out failed:",v),v}},t=async()=>w.hasPermission(),o=async()=>w.isEditor(),g=()=>{w.clearAvatarCache()};return{authState:r.value,isAuthenticated:a,isLoading:f,currentUser:d,error:h,signIn:u,signInWithRedirect:n,signOut:e,hasPermission:t,isEditor:o,clearAvatarCache:g}}function U(){const r=i([]),l=i(!1),a=i(null);let f=null;return P(()=>{f=c.subscribeToNewsletters(e=>{r.value=e})}),m(()=>{f?.()}),{newsletters:r,isLoading:l,error:a,loadNewsletters:async()=>{try{l.value=!0,a.value=null,r.value=await c.getAllNewsletterMetadata()}catch(e){a.value=e instanceof Error?e.message:"Failed to load newsletters",s.error("Failed to load newsletters:",e)}finally{l.value=!1}},searchNewsletters:async e=>{try{return l.value=!0,a.value=null,await c.searchNewsletters(e)}catch(t){return a.value=t instanceof Error?t.message:"Search failed",s.error("Newsletter search failed:",t),[]}finally{l.value=!1}},saveNewsletter:async e=>{try{const t=await c.saveNewsletterMetadata(e);return s.success("Newsletter saved:",t),t}catch(t){throw a.value=t instanceof Error?t.message:"Failed to save newsletter",s.error("Failed to save newsletter:",t),t}},updateNewsletter:async(e,t)=>{try{await c.updateNewsletterMetadata(e,t),s.success("Newsletter updated:",e)}catch(o){throw a.value=o instanceof Error?o.message:"Failed to update newsletter",s.error("Failed to update newsletter:",o),o}}}}function C(){const r=i(null),l=i(!1),a=i(null);return{uploadProgress:r,isUploading:l,error:a,uploadPdf:async(n,e)=>{try{l.value=!0,a.value=null,r.value=null;const t=e?await y.uploadNewsletterPdf(n,e,o=>{r.value=o}):await y.uploadPdf(n,{onProgress:o=>{r.value=o}});return s.success("PDF uploaded successfully:",t.storagePath),t}catch(t){throw a.value=t instanceof Error?t.message:"Upload failed",s.error("PDF upload failed:",t),t}finally{l.value=!1,r.value=null}},uploadFile:async(n,e)=>{try{l.value=!0,a.value=null,r.value=null;const t={onProgress:g=>{r.value=g}};e&&(t.folder=e);const o=await y.uploadFile(n,t);return s.success("File uploaded successfully:",o.storagePath),o}catch(t){throw a.value=t instanceof Error?t.message:"Upload failed",s.error("File upload failed:",t),t}finally{l.value=!1,r.value=null}},getStorageFiles:async n=>{try{return await y.listFiles(n)}catch(e){return a.value=e instanceof Error?e.message:"Failed to load files",s.error("Failed to load storage files:",e),[]}},deleteFile:async n=>{try{await y.deleteFile(n),s.success("File deleted:",n)}catch(e){throw a.value=e instanceof Error?e.message:"Failed to delete file",s.error("Failed to delete file:",e),e}}}}function N(){const r=i([]),l=i(!1),a=i(null),{isAuthenticated:f}=b();let d=null;return S(f,e=>{e?(s.info("User authenticated - setting up pending content subscription"),d=c.subscribeToPendingContent(t=>{r.value=t})):(s.info("User not authenticated - cleaning up pending content subscription"),d?.(),d=null,r.value=[])},{immediate:!0}),m(()=>{d?.()}),{pendingContent:r,isLoading:l,error:a,submitContent:async e=>{try{l.value=!0,a.value=null;const t=await c.submitUserContent(e);return s.success("Content submitted:",t),t}catch(t){throw a.value=t instanceof Error?t.message:"Failed to submit content",s.error("Failed to submit content:",t),t}finally{l.value=!1}},updateContentStatus:async(e,t,o)=>{try{await c.updateContentStatus(e,t,o),s.success("Content status updated:",e,t)}catch(g){throw a.value=g instanceof Error?g.message:"Failed to update status",s.error("Failed to update content status:",g),g}},loadPendingContent:async()=>{try{l.value=!0,a.value=null,r.value=await c.getPendingContent()}catch(e){a.value=e instanceof Error?e.message:"Failed to load pending content",s.error("Failed to load pending content:",e)}finally{l.value=!1}}}}function E(){const r=i(null),l=i(!1),a=i(null);return{userProfile:r,isLoading:l,error:a,loadUserProfile:async u=>{try{l.value=!0,a.value=null,r.value=await c.getUserProfile(u)}catch(n){a.value=n instanceof Error?n.message:"Failed to load profile",s.error("Failed to load user profile:",n)}finally{l.value=!1}},createUserProfile:async u=>{try{const n={...u,role:"reader",permissions:["read"],isApproved:!1};await c.createUserProfile(n),r.value={...n,createdAt:new Date().toISOString(),lastLoginAt:new Date().toISOString()},s.success("User profile created with reader role:",u.uid)}catch(n){throw a.value=n instanceof Error?n.message:"Failed to create profile",s.error("Failed to create user profile:",n),n}},updateUserProfile:async(u,n)=>{try{await c.updateUserProfile(u,n),r.value&&(r.value={...r.value,...n}),s.success("User profile updated:",u)}catch(e){throw a.value=e instanceof Error?e.message:"Failed to update profile",s.error("Failed to update user profile:",e),e}}}}function M(){const r=b(),l=U(),a=C(),f=N(),d=E();return{auth:r,newsletters:l,storage:a,userContent:f,userProfile:d}}export{M as u};
