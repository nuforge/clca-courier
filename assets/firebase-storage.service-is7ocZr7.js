import{by as f,bz as y,l as s,bA as l,bB as w,bC as E,bD as m,bE as T,bF as R,bG as b}from"./index-C_JkpTYA.js";import{f as p}from"./firebase-auth.service-DUJ5rzAl.js";class U{STORAGE_PATHS={NEWSLETTERS:"newsletters",USER_UPLOADS:"user-uploads",THUMBNAILS:"thumbnails",TEMP:"temp"};generateSafeFilename(a,e){const t=Date.now(),o=a.replace(/[^a-zA-Z0-9.-]/g,"_");return e?`${e}_${t}_${o}`:`${t}_${o}`}getStorageRef(a){return f(b,a)}async uploadPdf(a,e={}){try{const t=p.getCurrentUser();if(!t)throw new Error("User must be authenticated to upload files");if(!a.type.includes("pdf"))throw new Error("Only PDF files are allowed");const o=e.folder||this.STORAGE_PATHS.NEWSLETTERS,i=e.filename||this.generateSafeFilename(a.name,"newsletter"),r=`${o}/${i}`,d=this.getStorageRef(r),u={contentType:"application/pdf",customMetadata:{uploadedBy:t.uid,uploadedByEmail:t.email||"",originalName:a.name,uploadDate:new Date().toISOString(),...e.metadata?.customMetadata},...e.metadata},c=y(d,a,u);return new Promise((g,h)=>{c.on("state_changed",n=>{const S={bytesTransferred:n.bytesTransferred,totalBytes:n.totalBytes,percentage:n.bytesTransferred/n.totalBytes*100,state:n.state};e.onProgress?.(S),s.debug(`Upload progress: ${S.percentage.toFixed(2)}%`)},n=>{s.error("Upload error:",n),e.onError?.(n),h(n)},()=>{l(c.snapshot.ref).then(n=>{e.onComplete?.(n),s.success("Upload completed:",r),g({downloadUrl:n,storagePath:r})}).catch(n=>{h(n)})})})}catch(t){throw s.error("Upload error:",t),t}}async uploadFile(a,e={}){try{const t=p.getCurrentUser();if(!t)throw new Error("User must be authenticated to upload files");const o=e.folder||this.STORAGE_PATHS.USER_UPLOADS,i=e.filename||this.generateSafeFilename(a.name),r=`${o}/${i}`,d=this.getStorageRef(r),u={contentType:a.type,customMetadata:{uploadedBy:t.uid,uploadedByEmail:t.email||"",originalName:a.name,uploadDate:new Date().toISOString(),...e.metadata?.customMetadata},...e.metadata},c=await w(d,a,u),g=await l(c.ref);return s.success("File uploaded:",r),{downloadUrl:g,storagePath:r}}catch(t){throw s.error("File upload error:",t),t}}async getDownloadUrl(a){try{const e=this.getStorageRef(a);return await l(e)}catch(e){throw s.error("Error getting download URL:",e),e}}async deleteFile(a){try{if(!p.getCurrentUser())throw new Error("User must be authenticated to delete files");const t=this.getStorageRef(a);await E(t),s.success("File deleted:",a)}catch(e){throw s.error("Error deleting file:",e),e}}async getFileMetadata(a){try{const e=this.getStorageRef(a),t=await m(e),o=await l(e);return{name:t.name,fullPath:t.fullPath,size:t.size,contentType:t.contentType,downloadUrl:o,metadata:{customMetadata:t.customMetadata||void 0,cacheControl:t.cacheControl||void 0,contentDisposition:t.contentDisposition||void 0,contentEncoding:t.contentEncoding||void 0,contentLanguage:t.contentLanguage||void 0,contentType:t.contentType||void 0,md5Hash:t.md5Hash||void 0,timeCreated:t.timeCreated||void 0,updated:t.updated||void 0}}}catch(e){throw s.error("Error getting file metadata:",e),e}}async updateFileMetadata(a,e){try{const t=this.getStorageRef(a);await T(t,e),s.success("File metadata updated:",a)}catch(t){throw s.error("Error updating file metadata:",t),t}}async listFiles(a){try{const e=this.getStorageRef(a),t=await R(e),o=await Promise.all(t.items.map(async i=>{const r=await m(i),d=await l(i);return{name:r.name,fullPath:r.fullPath,size:r.size,contentType:r.contentType||void 0,downloadUrl:d,metadata:{customMetadata:r.customMetadata||void 0,cacheControl:r.cacheControl||void 0,contentDisposition:r.contentDisposition||void 0,contentEncoding:r.contentEncoding||void 0,contentLanguage:r.contentLanguage||void 0,contentType:r.contentType||void 0,md5Hash:r.md5Hash||void 0,timeCreated:r.timeCreated||void 0,updated:r.updated||void 0}}}));return s.info(`Listed ${o.length} files in ${a}`),o}catch(e){throw s.error("Error listing files:",e),e}}async getNewsletterPdfs(){return this.listFiles(this.STORAGE_PATHS.NEWSLETTERS)}async uploadNewsletterPdf(a,e,t){const o=a.name,i={folder:this.STORAGE_PATHS.NEWSLETTERS,filename:o,metadata:{customMetadata:{title:e.title,issueNumber:e.issueNumber||"",publicationDate:e.publicationDate,year:e.year.toString(),season:e.season||"",tags:e.tags?.join(",")||""}}};return t&&(i.onProgress=t),this.uploadPdf(a,i)}generateThumbnailPath(a,e="medium"){const t=a.split("/").pop()?.replace(".pdf","")||"thumbnail";return`${this.STORAGE_PATHS.THUMBNAILS}/${t}_${e}.jpg`}async fileExists(a){try{const e=this.getStorageRef(a);return await m(e),!0}catch{return!1}}async getStorageStats(){try{const[a,e]=await Promise.all([this.listFiles(this.STORAGE_PATHS.NEWSLETTERS),this.listFiles(this.STORAGE_PATHS.USER_UPLOADS)]),t=[...a,...e].reduce((o,i)=>o+i.size,0);return{totalFiles:a.length+e.length,totalSize:t,newsletterCount:a.length,userUploadCount:e.length}}catch(a){throw s.error("Error getting storage stats:",a),a}}}const F=new U;export{F as default,F as firebaseStorageService};
