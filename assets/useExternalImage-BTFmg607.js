var R=Object.defineProperty;var T=(m,e,t)=>e in m?R(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var v=(m,e,t)=>T(m,typeof e!="symbol"?e+"":e,t);import{r as d,c as U,w as S,b as C}from"./index-BkroMTFl.js";const h=class h{db=null;dbName="external-image-cache";dbVersion=1;storeName="images";maxCacheSize=50*1024*1024;defaultOptions={maxWidth:1920,maxHeight:1080,quality:.9,forceRefresh:!1,maxAge:10080*60*1e3};constructor(){}static getInstance(){return h.instance||(h.instance=new h),h.instance}async initDB(){return new Promise((e,t)=>{const a=indexedDB.open(this.dbName,this.dbVersion);a.onerror=()=>t(new Error("Failed to open IndexedDB")),a.onsuccess=()=>{this.db=a.result,e()},a.onupgradeneeded=o=>{const i=o.target.result;if(!i.objectStoreNames.contains(this.storeName)){const s=i.createObjectStore(this.storeName,{keyPath:"url"});s.createIndex("timestamp","timestamp",{unique:!1}),s.createIndex("size","size",{unique:!1})}}})}generateCacheKey(e,t){const a=JSON.stringify({maxWidth:t.maxWidth,maxHeight:t.maxHeight,quality:t.quality});return`${e}:${btoa(a)}`}isLocalUrl(e){return e.startsWith("/")||e.startsWith("./")||e.startsWith("../")||e.startsWith("data:")||!e.includes("://")}async processImage(e,t){return!t.maxWidth&&!t.maxHeight&&!t.quality?e:new Promise(a=>{const o=new Image;o.onload=()=>{const i=document.createElement("canvas"),s=i.getContext("2d");let{width:r,height:n}=o;t.maxWidth&&r>t.maxWidth&&(n=n*t.maxWidth/r,r=t.maxWidth),t.maxHeight&&n>t.maxHeight&&(r=r*t.maxHeight/n,n=t.maxHeight),i.width=r,i.height=n,s.drawImage(o,0,0,r,n),i.toBlob(l=>{a(l||e)},"image/jpeg",t.quality||.8)},o.onerror=()=>a(e),o.src=URL.createObjectURL(e)})}async cacheImage(e,t){if(this.db||await this.initDB(),!this.db)return;const a=await t.arrayBuffer(),o=URL.createObjectURL(t),i={url:e,data:a,mimeType:t.type||"image/jpeg",timestamp:Date.now(),size:t.size,objectUrl:o,metadata:{originalUrl:e,cacheKey:e,compressed:!0}};return new Promise((s,r)=>{const c=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(i);c.onsuccess=()=>s(),c.onerror=()=>r(new Error(c.error?.message||"Cache save error"))})}async getCachedImage(e){return this.db||await this.initDB(),this.db?new Promise((t,a)=>{const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);s.onsuccess=()=>{const r=s.result;if(r&&r.objectUrl){const n=new Image;n.onload=()=>t(r),n.onerror=()=>{const l=new Blob([r.data],{type:r.mimeType});r.objectUrl=URL.createObjectURL(l),t(r)},n.src=r.objectUrl}else if(r){const n=new Blob([r.data],{type:r.mimeType});r.objectUrl=URL.createObjectURL(n),t(r)}else t(null)},s.onerror=()=>a(new Error(s.error?.message||"Cache read error"))}):null}async getImage(e,t={}){try{const a={...this.defaultOptions,...t};if(this.isLocalUrl(e))return e;const o=this.generateCacheKey(e,t),i=await this.getCachedImage(o);if(i&&!(Date.now()-i.timestamp>a.maxAge)&&!a.forceRefresh)return i.objectUrl||null;try{const s=await fetch(e,{mode:"cors",headers:{Accept:"image/*"}});if(!s.ok)return console.warn(`Failed to fetch image: ${s.status} ${s.statusText}`,e),null;const r=await s.blob(),n=await this.processImage(r,a);return await this.cacheImage(o,n),URL.createObjectURL(n)}catch(s){return console.warn("CORS or network error loading external image:",s,"URL:",e),null}}catch(a){return console.error("Failed to fetch external image:",a),null}}async preloadImage(e,t={}){try{return await this.getImage(e,t)!==null}catch(a){return console.error("Failed to preload image:",a),!1}}async clearCache(){if(this.db||await this.initDB(),!!this.db)return new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();i.onsuccess=()=>e(),i.onerror=()=>t(new Error(i.error?.message||"Cache clear error"))})}async getCacheStats(){return this.db||await this.initDB(),this.db?new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();i.onsuccess=()=>{const s=i.result,r=s.length,n=s.reduce((c,f)=>c+f.size,0),l={count:r,totalSize:n};s.length>0&&(l.oldestEntry=Math.min(...s.map(c=>c.timestamp))),e(l)},i.onerror=()=>t(new Error(i.error?.message||"Cache stats error"))}):{count:0,totalSize:0}}};v(h,"instance");let x=h;const D=x.getInstance();async function M(m){return new Promise(e=>{const t=new Image;t.onload=()=>e(!0),t.onerror=()=>e(!1);const a=setTimeout(()=>{e(!1)},1e4);t.onload=()=>{clearTimeout(a),e(!0)},t.onerror=()=>{clearTimeout(a),e(!1)},t.src=m})}const w=["/images/clca-lake-3.jpg","/images/clca-moon-logo.png","/clca-moon-logo.png","data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyMCIgaGVpZ2h0PSIxMDgwIiB2aWV3Qm94PSIwIDAgMTkyMCAxMDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTkyMCIgaGVpZ2h0PSIxMDgwIiBmaWxsPSIjZjVmNWY1Ii8+Cjx0ZXh0IHg9Ijk2MCIgeT0iNTQwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNDgiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+SW1hZ2UgTm90IEF2YWlsYWJsZTwvdGV4dD4KPHN2Zz4K"];async function P(m){const e=m?[m,...w]:w;for(const a of e)if(await M(a))return a;return w[w.length-1]||"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyMCIgaGVpZ2h0PSIxMDgwIiB2aWV3Qm94PSIwIDAgMTkyMCAxMDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTkyMCIgaGVpZ2h0PSIxMDgwIiBmaWxsPSIjZjVmNWY1Ii8+Cjx0ZXh0IHg9Ijk2MCIgeT0iNTQwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNDgiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+SW1hZ2UgTm90IEF2YWlsYWJsZTwvdGV4dD4KPHN2Zz4K"}function B(m,e={}){const a={...{lazy:!0,placeholder:"",fallback:"",retryAttempts:3,retryDelay:1e3,maxAge:864e5,quality:.9,maxWidth:2048,maxHeight:2048,forceRefresh:!1},...e},o=d(a.placeholder||null),i=d(!1),s=d(!1),r=d(null),n=d(0),l=d(0),c=d(null),f=U(()=>typeof m=="string"?m:m?.value);async function p(g){for(l.value=0;l.value<a.retryAttempts;)try{l.value++,n.value=l.value/a.retryAttempts*50;const u=await D.getImage(g,{maxAge:a.maxAge,quality:a.quality,maxWidth:a.maxWidth,maxHeight:a.maxHeight,forceRefresh:a.forceRefresh});if(u)return n.value=100,u;throw new Error("Failed to load image")}catch(u){if(l.value>=a.retryAttempts)throw u;await new Promise(j=>setTimeout(j,a.retryDelay))}return null}async function y(){const g=f.value;if(!g){I();return}c.value&&c.value.abort(),c.value=new AbortController;try{i.value=!0,s.value=!1,r.value=null,n.value=0;const u=await p(g);if(c.value?.signal.aborted)return;if(u)o.value=u,s.value=!1;else throw new Error("Failed to load image after all retry attempts")}catch(u){if(c.value?.signal.aborted)return;console.error("External image load failed:",u),s.value=!0,r.value=u instanceof Error?u:new Error("Unknown error");try{const b=await P(a.fallback);o.value=b,s.value=!1,r.value=null}catch(b){console.warn("Fallback image loading failed:",b),o.value=a.placeholder||null}}finally{c.value?.signal.aborted||(i.value=!1,n.value=s.value?0:100)}}async function W(){const g=a.maxAge;a.maxAge=0;try{await y()}finally{a.maxAge=g}}function I(){c.value&&(c.value.abort(),c.value=null),o.value=a.placeholder||null,i.value=!1,s.value=!1,r.value=null,n.value=0,l.value=0}return S(f,g=>{g&&!a.lazy?y():g||I()},{immediate:!a.lazy}),C(()=>{c.value&&c.value.abort(),o.value&&o.value.startsWith("blob:")&&URL.revokeObjectURL(o.value)}),{imageUrl:o,isLoading:i,hasError:s,error:r,loadProgress:n,load:y,reload:W,clear:I}}export{B as u};
