import{l as a,bV as u,bW as l,bX as d,bY as p,bZ as g,b_ as o,b$ as w,c0 as f,c1 as m,c2 as A}from"./index-D_PnmBwd.js";class v{authState={user:null,isAuthenticated:!1,isLoading:!0,error:null};listeners=new Set;avatarCache=new Map;avatarCacheExpiry=new Map;AVATAR_CACHE_TTL=1e3*60*60;async cacheAvatarImage(t,e){try{const r=await(await fetch(t)).blob(),s=await new Promise(c=>{const h=new FileReader;h.onloadend=()=>c(h.result),h.readAsDataURL(r)}),n=Date.now();this.avatarCache.set(e,s),this.avatarCacheExpiry.set(e,n+this.AVATAR_CACHE_TTL),this.authState.user&&this.authState.user.uid===e&&(this.authState={...this.authState,user:{...this.authState.user,photoURL:s}},this.notifyListeners())}catch(i){a.warn("Failed to cache avatar image:",i);const r=Date.now();this.avatarCache.set(e,t),this.avatarCacheExpiry.set(e,r+this.AVATAR_CACHE_TTL)}}constructor(){this.initializeAuthListener()}initializeAuthListener(){u(o,t=>{this.authState={user:t?this.transformFirebaseUser(t):null,isAuthenticated:!!t,isLoading:!1,error:null},a.info("Auth state changed:",{isAuthenticated:this.authState.isAuthenticated,user:this.authState.user?.email}),this.notifyListeners()})}transformFirebaseUser(t){let e=t.photoURL;if(e){const i=Date.now(),r=t.uid,s=e;if(this.avatarCache.has(r)&&this.avatarCacheExpiry.has(r)){const n=this.avatarCacheExpiry.get(r);i<n?e=this.avatarCache.get(r):(e=this.avatarCache.get(r),this.cacheAvatarImage(s,r))}else this.cacheAvatarImage(s,r)}return{uid:t.uid,email:t.email,displayName:t.displayName,photoURL:e,emailVerified:t.emailVerified,isAnonymous:t.isAnonymous,metadata:{creationTime:t.metadata.creationTime||void 0,lastSignInTime:t.metadata.lastSignInTime||void 0},providerData:t.providerData.map(i=>({providerId:i.providerId,uid:i.uid,displayName:i.displayName,email:i.email,photoURL:i.photoURL}))}}getProvider(t){switch(t){case"google":{const e=new g;return e.addScope("email"),e.addScope("profile"),e}case"facebook":{const e=new p;return e.addScope("email"),e}case"twitter":return new d;case"github":{const e=new l;return e.addScope("user:email"),e}default:throw new Error(`Unsupported provider: ${String(t)}`)}}async signInWithPopup(t){try{this.authState.isLoading=!0,this.authState.error=null,this.notifyListeners();const e=this.getProvider(t);a.info(`ðŸ” Attempting sign in with ${t}`),a.info("Current domain:",window.location.hostname),a.info("Current origin:",window.location.origin),a.info("Firebase auth domain:",o.app.options.authDomain);const i=window.open("","_blank","width=1,height=1");i?(i.close(),a.info("âœ… Popup test passed - browser allows popups")):a.warn("âš ï¸ Popup blocked by browser - this will cause auth to fail");const r=await w(o,e);return a.success(`Sign in successful with ${t}:`,r.user.email),r}catch(e){const i=e instanceof Error?e.message:"Sign in failed";if(a.error(`Sign in error with ${t}:`,e),e instanceof Error){const r=e;if(a.error("Error code:",r.code||"unknown"),a.error("Error message:",e.message),r.code==="auth/popup-blocked"||r.code==="auth/popup-closed-by-user"||r.code==="auth/cancelled-popup-request"){a.warn("ðŸ”„ Popup failed, automatically falling back to redirect authentication..."),a.info("ðŸ’¡ You will be redirected to complete authentication");try{return await this.signInWithRedirect(t),new Promise(()=>{})}catch(s){throw a.error("âŒ Redirect fallback also failed:",s),this.authState.error="Authentication failed. Please enable popups or try again.",this.authState.isLoading=!1,this.notifyListeners(),s}}r.code==="auth/popup-closed-by-user"&&(a.warn("ðŸ’¡ Popup closed - this might indicate:"),a.warn("  1. User closed popup manually"),a.warn("  2. Popup blocked by browser"),a.warn("  3. OAuth configuration issue"),a.warn("  4. Domain not authorized in Firebase Console"))}throw this.authState.error=i,this.authState.isLoading=!1,this.notifyListeners(),e}}async signInWithRedirect(t){try{const e=this.getProvider(t);await f(o,e)}catch(e){throw a.error("Sign in with redirect error:",e),e}}async getRedirectResult(){try{return await m(o)}catch(t){throw a.error("Get redirect result error:",t),t}}async signOut(){try{await A(o),a.info("User signed out successfully")}catch(t){throw a.error("Sign out error:",t),t}}getAuthState(){return{...this.authState}}getCurrentUser(){return this.authState.user}isAuthenticated(){return this.authState.isAuthenticated}onAuthStateChange(t){return this.listeners.add(t),t(this.authState),()=>{this.listeners.delete(t)}}notifyListeners(){this.listeners.forEach(t=>t(this.authState))}hasPermission(){return this.authState.user?Promise.resolve(this.authState.isAuthenticated):Promise.resolve(!1)}async isEditor(){return this.hasPermission()}async getAccessToken(){if(!o.currentUser)return null;try{return await o.currentUser.getIdToken()}catch(t){return a.error("Error getting access token:",t),null}}clearAvatarCache(){this.avatarCache.clear(),this.avatarCacheExpiry.clear(),a.info("Avatar cache cleared")}getCachedAvatarUrl(t){const e=Date.now();if(this.avatarCache.has(t)&&this.avatarCacheExpiry.has(t)){const i=this.avatarCacheExpiry.get(t);if(e<i)return this.avatarCache.get(t)}return null}}const y=new v;export{y as f};
