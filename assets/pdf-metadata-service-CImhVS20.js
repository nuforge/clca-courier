import{getDocument as b,GlobalWorkerOptions as F}from"./pdf-ZhLmi4kS.js";const y=()=>typeof window<"u"?"/clca-courier/pdf.worker.min.js":"/pdf.worker.min.js";F.workerSrc=y();class D{cache=new Map;thumbnailCache=new Map;processingQueue=new Set;constructor(){this.loadCacheFromStorage()}async extractPDFMetadata(a,t){const e=`${t}`;if(this.cache.has(e))return this.cache.get(e);if(this.processingQueue.has(t))return null;try{this.processingQueue.add(t),console.log(`[PDFMetadataService] Processing PDF: ${t}`);const r=await b(a).promise,n=await r.getMetadata(),c=r.numPages,s=(await r.getPage(1)).getViewport({scale:1}),u={width:s.width,height:s.height},o=s.width/s.height,l=await this.generateThumbnailFromPDF(r),d=await this.estimateFileSize(a),g=Math.max(1,Math.round(c*2)),f=this.determineContentType(t,n.info),w=this.extractTopicsFromMetadata(t,n.info),h=n.info,p={filename:t,title:h?.Title||this.extractTitleFromFilename(t),pages:c,fileSize:d,thumbnailDataUrl:l,creationDate:h?.CreationDate?.toString(),modifiedDate:h?.ModDate?.toString(),author:h?.Author?.toString(),subject:h?.Subject?.toString(),producer:h?.Producer?.toString(),creator:h?.Creator?.toString(),language:h?.Language?.toString(),keywords:h?.Keywords?.toString()?.split(",").map(S=>S.trim())||[],pageSize:u,aspectRatio:o,estimatedReadTime:g,contentType:f,extractedTopics:w};return this.cache.set(e,p),this.thumbnailCache.set(t,l),this.saveCacheToStorage(),console.log(`[PDFMetadataService] Extracted metadata for: ${t}`),p}catch(r){return console.error(`[PDFMetadataService] Error processing ${t}:`,r),null}finally{this.processingQueue.delete(t)}}async generateThumbnailFromPDF(a){try{const t=await a.getPage(1),r=150/t.getViewport({scale:1}).width,n=t.getViewport({scale:r}),c=document.createElement("canvas"),i=c.getContext("2d");return c.width=n.width,c.height=n.height,await t.render({canvasContext:i,viewport:n}).promise,c.toDataURL("image/jpeg",.8)}catch(t){return console.error("[PDFMetadataService] Error generating thumbnail:",t),this.generatePlaceholderThumbnail()}}generatePlaceholderThumbnail(){const a=document.createElement("canvas"),t=a.getContext("2d");a.width=150,a.height=200;const e=t.createLinearGradient(0,0,150,200);return e.addColorStop(0,"#667eea"),e.addColorStop(1,"#764ba2"),t.fillStyle=e,t.fillRect(0,0,150,200),t.fillStyle="white",t.textAlign="center",t.font="bold 16px Arial",t.fillText("PDF",75,100),t.font="12px Arial",t.fillText("Thumbnail",75,120),a.toDataURL("image/jpeg",.8)}extractTitleFromFilename(a){const t=a.replace(/\.pdf$/i,""),e=t.match(/^(\d{4})\.(\d{2})-(.+)$/);if(e){const[,r,n]=e,c=["","January","February","March","April","May","June","July","August","September","October","November","December"],i=parseInt(n,10);return`${c[i]} ${r}`}return t.replace(/[-_]/g," ").replace(/\b\w/g,r=>r.toUpperCase())}async estimateFileSize(a){try{const e=(await fetch(a,{method:"HEAD"})).headers.get("content-length");if(e){const r=parseInt(e,10);return this.formatFileSize(r)}return"Unknown"}catch{return"Unknown"}}formatFileSize(a){if(a===0)return"0 B";const t=1024,e=["B","KB","MB","GB"],r=Math.floor(Math.log(a)/Math.log(t));return`${parseFloat((a/Math.pow(t,r)).toFixed(1))} ${e[r]}`}getCachedThumbnail(a){return this.thumbnailCache.get(a)||null}async processPDFBatch(a){console.log(`[PDFMetadataService] Processing batch of ${a.length} PDFs`);const t=await Promise.allSettled(a.map(r=>this.extractPDFMetadata(r.url,r.filename))),e=[];return t.forEach((r,n)=>{if(r.status==="fulfilled"&&r.value)e.push(r.value);else{const c=a[n];console.warn(`[PDFMetadataService] Failed to process: ${c?.filename||"unknown"}`)}}),console.log(`[PDFMetadataService] Successfully processed ${e.length}/${a.length} PDFs`),e}saveCacheToStorage(){try{const a={};this.cache.forEach((t,e)=>{a[e]={metadata:t,timestamp:Date.now()}}),localStorage.setItem("pdf-metadata-cache",JSON.stringify(a)),localStorage.setItem("pdf-thumbnail-cache",JSON.stringify(Object.fromEntries(this.thumbnailCache)))}catch(a){console.warn("[PDFMetadataService] Failed to save cache:",a)}}loadCacheFromStorage(){try{const a=localStorage.getItem("pdf-metadata-cache"),t=localStorage.getItem("pdf-thumbnail-cache");if(a){const e=JSON.parse(a);Object.entries(e).forEach(([r,n])=>{Date.now()-n.timestamp<1440*60*1e3&&this.cache.set(r,n.metadata)})}if(t){const e=JSON.parse(t);Object.entries(e).forEach(([r,n])=>{this.thumbnailCache.set(r,n)})}console.log(`[PDFMetadataService] Loaded ${this.cache.size} cached entries`)}catch(a){console.warn("[PDFMetadataService] Failed to load cache:",a)}}clearCache(){this.cache.clear(),this.thumbnailCache.clear(),localStorage.removeItem("pdf-metadata-cache"),localStorage.removeItem("pdf-thumbnail-cache")}determineContentType(a,t){const e=a.toLowerCase(),r=t?.Subject?.toLowerCase()||"",n=t?.Title?.toLowerCase()||"";return e.includes("annual")||r.includes("annual")||n.includes("annual")?"annual":e.includes("special")||r.includes("special")||n.includes("special")||e.includes("holiday")||e.includes("summer")||e.includes("winter")?"special":"newsletter"}extractTopicsFromMetadata(a,t){const e=[],r=t?.Subject||"",n=t?.Title||"",c=t?.Keywords||"",i=a.toLowerCase();i.includes("summer")&&e.push("Summer"),i.includes("winter")&&e.push("Winter"),i.includes("spring")&&e.push("Spring"),(i.includes("fall")||i.includes("autumn"))&&e.push("Fall"),i.includes("holiday")&&e.push("Holiday"),i.includes("annual")&&e.push("Annual");const s=n.toLowerCase();s.includes("summer")&&e.push("Summer"),s.includes("winter")&&e.push("Winter"),s.includes("spring")&&e.push("Spring"),(s.includes("fall")||s.includes("autumn"))&&e.push("Fall"),s.includes("holiday")&&e.push("Holiday"),s.includes("annual")&&e.push("Annual"),s.includes("special")&&e.push("Special Issue");const u=a.match(/(\d{4})\.(\d{2})-/);if(u&&u[2]){const o=parseInt(u[2],10),l=["January","February","March","April","May","June","July","August","September","October","November","December"];if(o>=1&&o<=12){const d=l[o-1];d&&e.push(d),[12,1,2].includes(o)?e.push("Winter"):[3,4,5].includes(o)?e.push("Spring"):[6,7,8].includes(o)?e.push("Summer"):[9,10,11].includes(o)&&e.push("Fall")}}if(r){const o=r.split(/[,;]/).map(l=>l.trim()).filter(l=>l.length>2);e.push(...o)}if(c){const o=c.split(/[,;]/).map(l=>l.trim()).filter(l=>l.length>2);e.push(...o)}return Array.from(new Set(e)).slice(0,10)}}const M=new D;export{M as p};
